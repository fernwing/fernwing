// Generated by LiveScript 1.2.0
var Firebase, FirebaseSimpleLogin, ga, fastDebug, x$;
angular.module('main', online
  ? ['firebase', 'ngAnimate', 'ld.common', 'backend']
  : ['ngAnimate', 'ld.common', 'backend']);
if (!online) {
  angular.module('main').factory('$firebase', function(){
    return function(){};
  });
}
if (!online) {
  Firebase = function(){};
  FirebaseSimpleLogin = function(){};
  ga = function(){};
}
fastDebug = true;
x$ = angular.module('main');
x$.config(function(){
  return $('a[href*=#]:not([href=#])').click(function(){
    var target;
    if (location.pathname.replace(/^\//, '') === this.pathname.replace(/^\//, '') && location.hostname === this.hostname) {
      ga('send', 'event', 'click', "#" + this.hash.slice(1));
      target = $(this.hash);
      target = target.length
        ? target
        : $("[name=" + this.hash.slice(1) + "]");
      if (target.length) {
        $("html,body").animate({
          scrollTop: target.offset().top
        }, 1000);
      }
      return false;
    }
  });
});
x$.directive('delayBk', function(){
  return {
    restrict: 'A',
    link: function(scope, e, attrs, ctrl){
      var url;
      url = attrs["delayBk"];
      return $('<img/>').attr('src', url).load(function(){
        $(this).remove();
        e.css({
          "background-image": "url(" + url + ")"
        });
        return setTimeout(function(){
          return e.toggleClass('visible');
        }, 100);
      });
    }
  };
});
x$.controller('notify', function($scope, $firebase, $timeout){
  $scope.dbRef = new Firebase('https://fern.firebaseIO.com/notify/');
  $scope.notify = $firebase($scope.dbRef);
  $scope.needFix = false;
  $scope.state = 0;
  $scope.postSubmitted = function(){
    return $scope.state = 2;
  };
  $scope.fix = function(it){
    if ($scope.needFix && !$scope[it]) {
      return "has-error";
    } else {
      return "";
    }
  };
  return $scope.submit = function(){
    var id;
    if (!$scope.email) {
      return $scope.needFix = true;
    }
    $scope.needFix = false;
    $scope.state = 1;
    id = $scope.notify.$add($scope.email);
    ga('send', 'event', 'notify', 'submit');
    return $timeout(function(){
      return $scope.postSubmitted();
    }, 2000);
  };
});
x$.controller('main', function($scope, $http, $firebase, $timeout, dbref, allpay, context){
  var zoomed, shown, count, x, y, v, r, s, m, idx, jdx, n, res$, i$, i, w, h;
  $scope.db = {
    order: null,
    count: null
  };
  $scope.user = context.user;
  $scope.$watch('user', function(){
    if ($scope.user) {
      return $scope.email = $scope.user.email;
    }
  });
  $scope.price = {
    red: 0,
    green: 0,
    cyan: 0,
    purple: 0,
    magenta: 0,
    black: 0
  };
  $scope.count = {
    red: 0,
    green: 0,
    cyan: 0,
    purple: 0,
    magenta: 0,
    black: 0
  };
  $scope.avail = {
    red: 0,
    green: 0,
    cyan: 0,
    purple: 0,
    magenta: 0,
    black: 0
  };
  $scope.choiceName = function(){
    var list;
    list = [['red', '紅色'], ['green', '綠色'], ['cyan', '藍色'], ['purple', '紫色'], ['magenta', '紫紅色'], ['black', '黑色']];
    list = list.filter(function(it){
      return $scope.count[it[0]];
    });
    list = list.map(function(it){
      return it[1] + " " + $scope.count[it[0]] + " 個";
    });
    return list.join('#');
  };
  $scope.priceTotal = function(){
    var ret;
    ret = ['red', 'green', 'cyan', 'purple', 'magenta', 'black'].map(function(it){
      return $scope.price[it] * $scope.count[it];
    }).reduce(function(a, b){
      return a + b;
    }, 0);
    if (ret > 0) {
      return ret += 50;
    }
  };
  $scope.choicelist = {};
  $scope.want = true;
  $scope.needFix = false;
  $scope.state = 0;
  $scope.submitted = false;
  $scope.fix = function(it){
    if ($scope.needFix && !$scope[it]) {
      return "has-error";
    } else {
      return "";
    }
  };
  $scope.dbref = dbref;
  $scope.loadcount = function(){
    return $http({
      url: '/d/stock',
      method: 'GET'
    }).success(function(d){
      var k, ref$, v, ref1$, i, results$ = [];
      $scope.price = d.price;
      $scope.avail = d.avail;
      for (k in ref$ = $scope.avail) {
        v = ref$[k];
        $scope.avail[k] = (ref1$ = $scope.avail[k]) > 0 ? ref1$ : 0;
        results$.push($scope.choicelist[k] = (fn$()));
      }
      return results$;
      function fn$(){
        var i$, to$, ref$, results$ = [];
        for (i$ = 0, to$ = (ref$ = v < 20 ? v : 20) > 0 ? ref$ : 0; i$ <= to$; ++i$) {
          i = i$;
          results$.push(i);
        }
        return results$;
      }
    });
  };
  $scope.loadcount();
  $scope.logout = function(){
    if ($scope.user) {
      return $http({
        url: '/d/logout',
        method: 'GET'
      }).success(function(d){
        $scope.user = null;
        return $scope.email = "", $scope.password = "", $scope.user = null, $scope;
      }).error(function(d){});
    }
  };
  $scope.clearForm = function(){
    var ref$;
    ref$ = {
      name: "",
      addr: "",
      email: "",
      password: "",
      phone: "",
      payment: "1"
    }, $scope.name = ref$.name, $scope.addr = ref$.addr, $scope.email = ref$.email, $scope.password = ref$.password, $scope.phone = ref$.phone, $scope.payment = ref$.payment;
    if ($scope.user) {
      $scope.email = $scope.user.email;
    }
    return $scope.state = 0;
  };
  $scope.postSubmitted = function(){
    return $scope.state = 2;
  };
  $scope.submit = function(){
    var payload;
    if (!($scope.name && $scope.addr && $scope.email && ($scope.user || $scope.password) && $scope.phone && $scope.priceTotal())) {
      return $scope.needFix = true, $scope.state = 0, $scope;
    }
    $scope.needFix = false;
    $scope.state = 1;
    if (!$scope.user) {
      $http({
        url: '/d/login',
        method: 'POST',
        data: JSON.stringify({
          username: $scope.email,
          password: $scope.password
        })
      }).success(function(d){
        return $scope.user = d;
      }).error(function(d){});
    }
    payload = {
      name: $scope.name,
      email: $scope.email,
      addr: $scope.addr,
      phone: $scope.phone,
      count: $scope.count
    };
    $scope.allpay(payload);
    return $timeout(function(){
      return $scope.postSubmitted();
    }, 2000);
  };
  $scope.allpay = function(payload){
    return $http({
      url: '/d/order/init',
      method: 'POST',
      headers: {
        "Content-Type": "application/json"
      },
      data: payload
    }).success(function(d){
      console.log("payload information (to allpay): " + d);
      $scope.allPayData = d;
      return $timeout(function(){
        return $('#allpayform').submit();
      }, 100);
    }).error(function(e){
      return console.error(e);
    });
  };
  if (typeof fastDebug !== "undefined" && fastDebug) {
    $scope.name = "薄瓜瓜";
    $scope.addr = "在大陸的薄瓜瓜的家";
    $scope.phone = "0110101011";
  }
  $scope.payment = 1;
  zoomed = false;
  shown = false;
  $scope.st = {};
  $scope.anchor = ['wing-feature', 'order', 'order-info', 'about', 'gallery'];
  $scope.anchor.map(function(it){
    return $scope.st["#" + it] = ($("#" + it).offset() || {}).top;
  });
  $scope.reach = {};
  $(window).scroll(function(e){
    var h, t, i$, ref$, len$, item, results$ = [];
    h = $(window).height();
    t = $(window).scrollTop();
    if (t > $scope.st['#wing-feature'] - h / 2 && !zoomed) {
      zoomed = true;
      $('#feature img').addClass('zoom');
      $('#feature .feature').addClass('zoom');
    }
    if (t > $scope.st['#order-info'] - h / 2 && !shown) {
      shown = true;
      $('#order').addClass('shown');
      ga('send', 'event', 'form', 'reach');
    }
    for (i$ = 0, len$ = (ref$ = $scope.anchor).length; i$ < len$; ++i$) {
      item = ref$[i$];
      if (t > $scope.st[item] && !$scope.reach[item]) {
        results$.push(ga('send', 'event', 'scroll', item));
      }
    }
    return results$;
  });
  count = 100;
  x = new Array(count);
  y = new Array(count);
  v = new Array(count);
  r = new Array(count);
  s = new Array(count);
  m = new Array(count);
  idx = new Array(count);
  jdx = new Array(count);
  res$ = [];
  for (i$ = 0; i$ < 100; ++i$) {
    i = i$;
    res$.push($("<div class='feather'><div class='bk'></div><div class='img'></div></div>"));
  }
  n = res$;
  w = $(window).width();
  h = $(window).height();
  for (i$ = 0; i$ < 30; ++i$) {
    i = i$;
    x[i] = Math.random() * -500;
    v[i] = Math.random() * 14;
    y[i] = Math.random() * 3 * h / 4 + h / 4;
    s[i] = Math.random() * 1;
    r[i] = parseInt(Math.random() * 360);
    idx[i] = Math.random() * 6.28;
    jdx[i] = Math.random() * 0.5;
    $('#feathers').append(n[i]);
    m[i] = n[i].find('div');
  }
  if (false) {
    return setInterval(function(){
      var i$, i, cy, results$ = [];
      for (i$ = 0; i$ < 50; ++i$) {
        i = i$;
        x[i] += v[i] / 2 + v[i] * Math.cos(idx[i]);
        cy = y[i] + (h / 6) * Math.sin(jdx[i]);
        r[i] += parseInt(Math.random() * 3);
        idx[i] += 0.011;
        jdx[i] += 0.007;
        n[i].css({
          top: cy,
          left: x[i],
          opacity: s[i]
        });
        if (m[i]) {
          m[i].css({
            "-webkit-transform": "rotate(" + r[i] + "deg) scale(" + s[i] + ")"
          });
        }
        if (x[i] >= w) {
          results$.push(x[i] = Math.random() * -100);
        }
      }
      return results$;
    }, 50);
  }
});